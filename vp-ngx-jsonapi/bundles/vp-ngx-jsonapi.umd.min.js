!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common"),require("@angular/common/http"),require("rxjs/util/noop"),require("rxjs/add/operator/toPromise"),require("rxjs/add/operator/map"),require("localforage"),require("rxjs/util/isFunction"),require("rxjs/util/isArray"),require("rxjs/Subject"),require("rxjs/BehaviorSubject"),require("rxjs/util/isObject")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common","@angular/common/http","rxjs/util/noop","rxjs/add/operator/toPromise","rxjs/add/operator/map","localforage","rxjs/util/isFunction","rxjs/util/isArray","rxjs/Subject","rxjs/BehaviorSubject","rxjs/util/isObject"],t):t(e["vp-ngx-jsonapi"]={},e.ng.core,e.common,e.http,e.noop,null,null,e.localforage,e.isFunction,e.isArray,e.Subject,e.BehaviorSubject,e.isObject)}(this,function(e,t,r,i,n,o,s,a,c,u,l,p,h){"use strict";var f,d=(f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])},function(e,t){function r(){this.constructor=e}f(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),v=function(e,t){var r,i,n,o,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,i&&(n=i[2&o[0]?"return":o[0]?"throw":"next"])&&!(n=n.call(i,o[1])).done)return n;switch(i=0,n&&(o=[0,n.value]),o[0]){case 0:case 1:n=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,i=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(n=(n=s.trys).length>0&&n[n.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){s.label=o[1];break}if(6===o[0]&&s.label<n[1]){s.label=n[1],n=o;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(o);break}n[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],i=0}finally{r=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},y=function(){return function(){this.number=0,this.total_resources=0,this.resources_per_page=0}}(),m=function(){function e(){}return e.newCollection=function(){return Object.defineProperties({},{$length:{get:function(){return 1*Object.keys(this).length},enumerable:!1},$toArray:{get:function(){var e=this;return Object.keys(this).map(function(t){return e[t]})},enumerable:!1},$is_loading:{value:!1,enumerable:!1,writable:!0},$source:{value:"",enumerable:!1,writable:!0},$cache_last_update:{value:0,enumerable:!1,writable:!0},page:{value:new y,enumerable:!1,writable:!0}})},e.isObjectLive=function(e,t){return e>=0&&Date.now()<=t+1e3*e},e.forEach=function(e,t){Object.keys(e).forEach(function(r){t(e[r],r)})},e}();m.Params={id:"",include:[]},m.Schema={relationships:{},ttl:0};var g=function(){return function(){this.url="http://yourdomain/api/v1/",this.params_separator="?",this.unify_concurrency=!0,this.cache_prerequests=!0,this.cachestore_support=!0,this.parameters={page:{number:"page[number]",size:"page[size]"}}}}(),_=function(){return function(){var e=this;this.promise=new Promise(function(t,r){e.resolve=t,e.reject=r})}}(),b=function(e,t,r,i){return new(r||(r=Promise))(function(n,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function a(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){e.done?n(e.value):new r(function(t){t(e.value)}).then(s,a)}c((i=i.apply(e,t||[])).next())})},S=function(){function e(){this.calls={}}return e.prototype.hasPromises=function(e){return e in this.calls},e.prototype.getAPromise=function(e){return b(this,void 0,void 0,function(){var t;return v(this,function(r){return e in this.calls||(this.calls[e]=[]),t=new _,this.calls[e].push(t),[2,t.promise]})})},e.prototype.setPromiseRequest=function(e,t){return b(this,void 0,void 0,function(){var r=this;return v(this,function(i){return t.then(function(t){if(e in r.calls){for(var i=0,n=r.calls[e];i<n.length;i++){n[i].resolve(t)}delete r.calls[e]}}).catch(function(t){if(e in r.calls){for(var i=0,n=r.calls[e];i<n.length;i++){n[i].reject(t)}delete r.calls[e]}}),[2]})})},e}(),j=function(e,t,r,i){return new(r||(r=Promise))(function(n,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function a(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){e.done?n(e.value):new r(function(t){t(e.value)}).then(s,a)}c((i=i.apply(e,t||[])).next())})},w=function(){function e(e,t,r){this.http=e,this.rsJsonapiConfig=t,this.noDuplicatedHttpCallsService=r}return e.prototype.delete=function(e){return j(this,void 0,void 0,function(){return v(this,function(t){return[2,this.exec(e,"DELETE")]})})},e.prototype.get=function(e){return j(this,void 0,void 0,function(){return v(this,function(t){return[2,this.exec(e,"get")]})})},e.prototype.exec=function(e,t,r,n){return void 0===n&&(n=!0),j(this,void 0,void 0,function(){var o,s,a,c;return v(this,function(u){return o=null,"get"===t&&this.noDuplicatedHttpCallsService.hasPromises(e)||(s=new i.HttpRequest(t,this.rsJsonapiConfig.url+e,r||null,{headers:new i.HttpHeaders({"Content-Type":"application/vnd.api+json",Accept:"application/vnd.api+json"})}),a=this.http.request(s),"get"===t?this.noDuplicatedHttpCallsService.setPromiseRequest(e,a.toPromise()):o=a.toPromise()),null===o&&(o=this.noDuplicatedHttpCallsService.getAPromise(e)),c=new _,O.me.refreshLoadings(1),o.then(function(e){e=e.body||e,O.me.refreshLoadings(-1),c.resolve(e)}).catch(function(e){e=e.error||e,O.me.refreshLoadings(-1),e.status<=0?O.me.loadingsOffline(e)||console.warn("Jsonapi.Http.exec (use JsonapiCore.loadingsOffline for catch it) error =>",e):n&&!O.me.loadingsError(e)&&console.warn("Jsonapi.Http.exec (use JsonapiCore.loadingsError for catch it) error =>",e),c.reject(e)}),[2,c.promise]})})},e}();w.decorators=[{type:t.Injectable}],w.ctorParameters=function(){return[{type:i.HttpClient},{type:g},{type:S}]};var C=function(e,t,r,i){return new(r||(r=Promise))(function(n,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function a(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){e.done?n(e.value):new r(function(t){t(e.value)}).then(s,a)}c((i=i.apply(e,t||[])).next())})},x=function(){function e(){this.globalstore=a.createInstance({name:"jsonapiglobal"}),this.allstore=a.createInstance({name:"allstore"}),this.checkIfIsTimeToClean()}return e.prototype.checkIfIsTimeToClean=function(){var e=this;this.globalstore.getItem("_lastclean_time").then(function(t){Date.now()>=t.time+432e5&&(e.globalstore.setItem("_lastclean_time",{time:Date.now()}),e.checkAndDeleteOldElements())}).catch(function(){e.globalstore.setItem("_lastclean_time",{time:Date.now()})})},e.prototype.checkAndDeleteOldElements=function(){var e=this;this.allstore.keys().then(function(t){m.forEach(t,function(t){e.allstore.getItem(t).then(function(r){Date.now()>=r._lastupdate_time+864e5&&e.allstore.removeItem(t)}).catch(n.noop)})}).catch(n.noop)},e.prototype.getObjet=function(e){return C(this,void 0,void 0,function(){var t;return v(this,function(r){return t=new _,this.allstore.getItem("jsonapi."+e).then(function(e){t.resolve(e)}).catch(function(e){t.reject(e)}),[2,t.promise]})})},e.prototype.getObjets=function(e){return C(this,void 0,void 0,function(){return v(this,function(t){return[2,this.allstore.getItem("jsonapi."+e[0])]})})},e.prototype.saveObject=function(e,t){t._lastupdate_time=Date.now(),this.allstore.setItem("jsonapi."+e,t)},e.prototype.clearCache=function(){this.allstore.clear(),this.globalstore.clear()},e.prototype.deprecateObjectsWithKey=function(e){var t=this;this.allstore.keys().then(function(r){m.forEach(r,function(r){r.startsWith(e)&&t.allstore.getItem(r).then(function(e){e._lastupdate_time=0,t.allstore.setItem(r,e)}).catch(n.noop)})}).catch(n.noop)},e}();var O=function(){function e(t,r,i){for(var o in this.resourceServices={},this.loadingsCounter=0,this.loadingsStart=n.noop,this.loadingsDone=n.noop,this.loadingsError=n.noop,this.loadingsOffline=n.noop,this.config=new g,this.config)this.config[o]=(this.config[o],this.config[o]);e.me=this,e.injectedServices={JsonapiStoreService:r,JsonapiHttp:i,rsJsonapiConfig:this.config}}return e.prototype.registerService=function(e){return!(e.type in this.resourceServices)&&(this.resourceServices[e.type]=e,e)},e.prototype.getResourceService=function(e){return this.resourceServices[e]},e.prototype.refreshLoadings=function(e){this.loadingsCounter+=e,0===this.loadingsCounter?this.loadingsDone():1===this.loadingsCounter&&this.loadingsStart()},e.prototype.clearCache=function(){return e.injectedServices.JsonapiStoreService.clearCache(),!0},e.prototype.duplicateResource=function(e){for(var t=this,r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];var n,o,s=this.getResourceService(e.type).new();return s.attributes=Object.assign({},s.attributes,e.attributes),s.attributes.name=s.attributes.name+" xXx",n=e.relationships,o=function(e,i){"id"in e.data?r.indexOf(i)>-1?s.addRelationship(t.duplicateResource(e.data),i):s.addRelationship(e.data,i):r.indexOf(i)>-1?m.forEach(e.data,function(e){s.addRelationship(t.duplicateResource(e),i)}):s.addRelationships(e.data,i)},Object.keys(n).forEach(function(e){o(e,n[e])}),s},e}();O.decorators=[{type:t.Injectable}],O.ctorParameters=function(){return[{type:g,decorators:[{type:t.Optional}]},{type:x},{type:w}]};var R=function(){function e(e,t){if(e)throw new Error("VpNgxJsonapiModule is already loaded. Import it in the AppModule only")}return e.forRoot=function(t){return{ngModule:e,providers:[{provide:g,useValue:t}]}},e}();R.decorators=[{type:t.NgModule,args:[{imports:[r.CommonModule],exports:[i.HttpClientModule],providers:[O,S,x,w]}]}],R.ctorParameters=function(){return[{type:R,decorators:[{type:t.Optional},{type:t.SkipSelf}]},{type:O}]};var P=function(){function e(){}return e.prototype.proccess_exec_params=function(e){return c.isFunction(e.params)?(e.fc_error=e.fc_success,e.fc_success=e.params,e.params=Object.assign({},m.Params)):void 0===e.params?e.params=Object.assign({},m.Params):e.params=Object.assign({},m.Params,e.params),e.fc_success=c.isFunction(e.fc_success)?e.fc_success:n.noop,e.fc_error=c.isFunction(e.fc_error)?e.fc_error:void 0,e},e.prototype.runFc=function(e,t){return c.isFunction(e)?e(t):n.noop()},e}(),E=function(){function e(){this.paths=[],this.includes=[],this.get_params=[]}return e.prototype.applyParams=function(e,t){void 0===t&&(t={}),this.appendPath(e.getPrePath()),t.beforepath&&this.appendPath(t.beforepath),this.appendPath(e.getPath()),t.include&&this.setInclude(t.include)},e.prototype.appendPath=function(e){""!==e&&this.paths.push(e)},e.prototype.addParam=function(e){this.get_params.push(e)},e.prototype.setInclude=function(e){this.includes=e},e.prototype.getForCache=function(){return this.paths.join("/")+this.get_params.join("/")},e.prototype.get=function(){var e=this.get_params.slice();return this.includes.length>0&&e.push("include="+this.includes.join(",")),this.paths.join("/")+(e.length>0?O.injectedServices.rsJsonapiConfig.params_separator+e.join("&"):"")},e}(),F=function(){function e(e,t,r,i,n){this.getService=e,this.relationships_from=t,this.relationships_dest=r,this.included_resources=i,this.schema=n}return e.prototype.buildRelationships=function(){var e=this;m.forEach(this.relationships_from,function(t,r){!(r in e.relationships_dest)&&"data"in t&&(e.relationships_dest[r]={data:m.newCollection(),content:"collection"}),t.data&&(e.schema.relationships[r]&&e.schema.relationships[r].hasMany?e.__buildRelationshipHasMany(t,r):e.__buildRelationshipHasOne(t,r))})},e.prototype.__buildRelationshipHasMany=function(e,t){var r=e.data[0]?e.data[0].type:"";r=r||t,this.getService(r)?this.__buildRelationshipCollection(e,t):this.__buildRelationshipDataCollection(e,t)},e.prototype.__buildRelationshipDataCollection=function(e,t){this.relationships_dest[t]={data:e.data,content:"ids"}},e.prototype.__buildRelationshipCollection=function(e,t){var r=this;if(0!==e.data.length){var i=m.newCollection();this.relationships_dest[t].content="collection",m.forEach(e.data,function(e){var n=r.__buildRelationship(e,r.included_resources);!("attributes"in n)&&n.id in r.relationships_dest[t].data&&"attributes"in r.relationships_dest[t].data[n.id]?i[n.id]=r.relationships_dest[t].data[n.id]:i[n.id]=n,"attributes"in n||(r.relationships_dest[t].content="ids")});var n={};m.forEach(e.data,function(e){n[e.id]=!0}),m.forEach(this.relationships_dest[t].data,function(e){e.id in n||delete r.relationships_dest[e.id]}),this.relationships_dest[t].data=i}else this.relationships_dest[t]={data:m.newCollection(),content:"collection"}},e.prototype.__buildRelationshipHasOne=function(e,t){if("type"in e.data){if(null!=this.relationships_dest[t].data&&e.data.id===this.relationships_dest[t].data.id||(this.relationships_dest[t].data={}),!this.relationships_dest[t].data.attributes||this.relationships_dest[t].data.id!==e.data.id){var r=this.__buildRelationship(e.data,this.included_resources);this.relationships_dest[t].data=r}}else this.relationships_dest[t].data={}},e.prototype.__buildRelationship=function(e,t){if(e.type in t&&e.id in t[e.type])return t[e.type][e.id];var r=this.getService(e.type);return r&&e.id in r.cachememory.resources?r.cachememory.resources[e.id]:(r&&r.cachestore.getResource(e).catch(n.noop),e)},e}(),A=function(){function e(){}return e.json_array2resources_array=function(t,r){void 0===r&&(r={});for(var i=0,n=t;i<n.length;i++){var o=n[i],s=e.json2resource(o,!1);r[s.type+"_"+s.id]=s}},e.json_array2resources_array_by_type=function(t){var r={},i={};return e.json_array2resources_array(t,r),m.forEach(r,function(e){e.type in i||(i[e.type]={}),i[e.type][e.id]=e}),i},e.json2resource=function(t,r){if(e.getService(t.type))return e.procreate(t);console.warn("`"+t.type+"`","service not found on json2resource()");var i=new I;return i.id=t.id,i.type=t.type,i},e.getService=function(e){return O.me.getResourceService(e)},e.procreate=function(t){var r;return"type"in t&&"id"in t||console.error("Jsonapi Resource is not correct",t),(r=t.id in e.getService(t.type).cachememory.resources?e.getService(t.type).cachememory.resources[t.id]:e.getService(t.type).cachememory.getOrCreateResource(t.type,t.id)).attributes=t.attributes||{},r.is_new=!1,r},e.build=function(t,r){var i={};"included"in t&&(i=e.json_array2resources_array_by_type(t.included)),Array.isArray(t.data)?e._buildCollection(t,r,i):e._buildResource(t.data,r,i)},e._buildCollection=function(t,r,i){r.page&&t.meta&&(r.page.number=t.meta.page||1,r.page.resources_per_page=t.meta.resources_per_page||null,r.page.total_resources=t.meta.total_resources||null);for(var n={},o=0,s=t.data;o<s.length;o++){var a=s[o];a.id in r||(r[a.id]=e.getService(a.type).cachememory.getOrCreateResource(a.type,a.id)),e._buildResource(a,r[a.id],i),n[a.id]=a.id}m.forEach(r,function(e){e.id in n||delete r[e.id]})},e._buildResource=function(t,r,i){r.id=t.id||"",r.attributes=t.attributes||{},r.is_new=!1;var n=e.getService(t.type);r.relationships&&n&&(e.getService(t.type).parseFromServer(r.attributes),new F(e.getService,t.relationships||{},r.relationships,i,n.schema).buildRelationships())},e}(),J=function(e,t,r,i){return new(r||(r=Promise))(function(n,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function a(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){e.done?n(e.value):new r(function(t){t(e.value)}).then(s,a)}c((i=i.apply(e,t||[])).next())})},I=function(e){function t(){var t=e.apply(this,arguments)||this;return t.is_new=!0,t.is_loading=!1,t.is_saving=!1,t.id="",t.type="",t.attributes={},t.relationships={},t}return d(t,e),t.prototype.reset=function(){var e=this;this.id="",this.attributes={},this.relationships={},m.forEach(this.getService().schema.relationships,function(t,r){if(e.getService().schema.relationships[r].hasMany){var i={data:m.newCollection(),content:"collection"};e.relationships[r]=i}else{i={data:{},content:"none"};e.relationships[r]=i}}),this.is_new=!0},t.prototype.toObject=function(e){var t=this;e=Object.assign({},m.Params,e);var r,i={},n=[],o=[];m.forEach(this.relationships,function(r,s){if(t.getService().schema.relationships[s]&&t.getService().schema.relationships[s].hasMany)i[s]={data:[]},m.forEach(r.data,function(t){var r={id:t.id,type:t.type};i[s].data.push(r);var a=t.type+"_"+t.id;-1===o.indexOf(a)&&-1!==e.include.indexOf(s)&&(o.push(a),n.push(t.toObject({}).data))});else{var a=r.data;!("id"in r.data)&&Object.keys(r.data).length>0&&console.warn(s+" defined with hasMany:false, but I have a collection"),a.id&&a.type?i[s]={data:{id:a.id,type:a.type}}:i[s]={data:{}};var c=a.type+"_"+a.id;-1===o.indexOf(c)&&-1!==e.include.indexOf(a.type)&&(o.push(c),n.push(a.toObject({}).data))}}),this.getService()&&this.getService().parseToServer?(r=Object.assign({},this.attributes),this.getService().parseToServer(r)):r=this.attributes;var s={data:{type:this.type,id:this.id,attributes:r,relationships:i}};return n.length>0&&(s.included=n),s},t.prototype.save=function(e,t,r){return J(this,void 0,void 0,function(){return v(this,function(i){return[2,this.__exec({id:null,params:e,fc_success:t,fc_error:r,exec_type:"save"})]})})},t.prototype.__exec=function(e){return J(this,void 0,void 0,function(){var t;return v(this,function(r){switch(t=this.proccess_exec_params(e),e.exec_type){case"save":return[2,this._save(t.params,e.fc_success,e.fc_error)]}return[2]})})},t.prototype._save=function(e,t,r){return J(this,void 0,void 0,function(){var i=this;return v(this,function(n){return[2,new Promise(function(n,o){if(!i.is_saving&&!i.is_loading){i.is_saving=!0;var s=i.toObject(e),a=new E;a.applyParams(i.getService(),e),i.id&&a.appendPath(i.id),O.injectedServices.JsonapiHttp.exec(a.get(),i.id?"PATCH":"POST",s,!c.isFunction(r)).then(function(e){if(i.is_saving=!1,i.id||(i.getService().cachememory.deprecateCollections(a.get()),i.getService().cachestore.deprecateCollections(a.get())),"id"in e.data)i.id=e.data.id,A.build(e,i);else if(u.isArray(e.data)){console.warn("Server return a collection when we save()",e.data);var r=i.getService().cachememory.getOrCreateCollection("justAnUpdate");A.build(e,r),m.forEach(r,function(e,t){var r=A.getService(e.type).cachememory.resources[e.id];A.getService(e.type).cachememory.setResource(e),A.getService(e.type).cachestore.setResource(e),r.id=r.id+"x"}),console.warn("Temporal collection for a resource_value update",r)}i.runFc(t,e),n(e)}).catch(function(e){i.is_saving=!1,i.runFc(r,"data"in e?e.data:e),o("data"in e?e.data:e)})}})]})})},t.prototype.addRelationship=function(e,t){var r=e.id;r||(r="new_"+Math.floor(1e5*Math.random())),(t=t||e.type)in this.relationships||(this.relationships[t]={data:{},content:"none"}),t in this.getService().schema.relationships&&this.getService().schema.relationships[t].hasMany?this.relationships[t].data[r]=e:this.relationships[t].data=e},t.prototype.addRelationships=function(e,t){var r=this;t in this.relationships?m.forEach(this.relationships[t].data,function(i){i.id in e||delete r.relationships[t].data[i.id]}):this.relationships[t]={data:{},content:"none"},m.forEach(e,function(e){r.relationships[t].data[e.id]=e})},t.prototype.addRelationshipsArray=function(e,t){var r=this;e.forEach(function(e){r.addRelationship(e,t||e.type)})},t.prototype.removeRelationship=function(e,t){if(!(e in this.relationships))return!1;if(!("data"in this.relationships[e]))return!1;if(e in this.getService().schema.relationships&&this.getService().schema.relationships[e].hasMany){if(!(t in this.relationships[e].data))return!1;delete this.relationships[e].data[t]}else this.relationships[e].data={};return!0},t.prototype.getService=function(){return A.getService(this.type)},t}(P),M=function(){function e(){}return e.prototype.toparamsarray=function(e,t){var r=this;void 0===t&&(t="");var i="";return Array.isArray(e)||h.isObject(e)?m.forEach(e,function(e,n){i+=r.toparamsarray(e,t+"["+n+"]")}):i+=t+"="+e,i},e.prototype.toparams=function(e){var t=this,r="";return m.forEach(e,function(e,i){r+=t.toparamsarray(e,"&"+i)}),r.slice(1)},e}(),H=function(){function e(e){this.localfilterparams=e||{}}return e.prototype.passFilter=function(e,t){for(var r in t){if(!("object"==typeof e&&"attributes"in e))return!0;if("object"==typeof t[r])return t[r].test(e.attributes[r]);if("string"==typeof e.attributes[r])return e.attributes[r]===t[r]}return!1},e.prototype.filterCollection=function(e,t){var r=this;Object.keys(this.localfilterparams).length&&m.forEach(e,function(e,i){r.passFilter(e,r.localfilterparams)&&(t[i]=e)})},e}(),k=function(){function e(){}return e.resourceToResource=function(e,t){for(var r in t.attributes=e.attributes,t.relationships)if(r in e.relationships){if(!("id"in t.relationships[r].data))for(var i in t.relationships[r].data)i in e.relationships[r].data||delete t.relationships[r]}else delete t.relationships[r];for(var r in e.relationships)"id"in e.relationships[r].data?t.addRelationship(e.relationships[r].data,r):t.addRelationships(e.relationships[r].data,r)},e}(),D=function(){function e(){this.collections={},this.collections_lastupdate={},this.resources={}}return e.prototype.isCollectionExist=function(e){return e in this.collections&&"new"!==this.collections[e].$source},e.prototype.isCollectionLive=function(e,t){return Date.now()<=this.collections_lastupdate[e]+1e3*t},e.prototype.isResourceLive=function(e,t){return this.resources[e]&&Date.now()<=this.resources[e].lastupdate+1e3*t},e.prototype.getOrCreateCollection=function(e){return e in this.collections||(this.collections[e]=m.newCollection(),this.collections[e].$source="new"),this.collections[e]},e.prototype.setCollection=function(e,t){var r=this;this.collections[e]=m.newCollection(),Object.keys(t).forEach(function(i){var n=t[i];r.collections[e][i]=n,r.setResource(n)}),this.collections[e].page=t.page,this.collections_lastupdate[e]=Date.now()},e.prototype.getOrCreateResource=function(e,t){if(A.getService(e).cachememory&&t in A.getService(e).cachememory.resources)return A.getService(e).cachememory.resources[t];var r=A.getService(e).new();return r.id=t,this.setResource(r,!1),r},e.prototype.setResource=function(e,t){void 0===t&&(t=!1),e.id in this.resources?k.resourceToResource(e,this.resources[e.id]):this.resources[e.id]=e,this.resources[e.id].lastupdate=t?Date.now():0},e.prototype.deprecateCollections=function(e){var t=this;return m.forEach(this.collections_lastupdate,function(e,r){t.collections_lastupdate[r]=0}),!0},e.prototype.removeResource=function(e){m.forEach(this.collections,function(t,r){delete t[e]}),this.resources[e].attributes={},this.resources[e].relationships={},delete this.resources[e]},e}(),$=function(e,t,r,i){return new(r||(r=Promise))(function(n,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function a(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){e.done?n(e.value):new r(function(t){t(e.value)}).then(s,a)}c((i=i.apply(e,t||[])).next())})},T=function(){function e(){}return e.prototype.getResource=function(e,t){return void 0===t&&(t=[]),$(this,void 0,void 0,function(){var r=this;return v(this,function(i){return[2,new Promise(function(i,n){O.injectedServices.JsonapiStoreService.getObjet(e.type+"."+e.id).then(function(o){A.build({data:o},e);var s=[];m.forEach(t,function(t){if(t in e.relationships){var i=e.relationships[t].data;if(!("attributes"in i)){var n=r.getResourceFromMemory(i);n.is_new?s.push(r.getResource(n)):console.warn("ts-angular-json: esto no debería pasar #isdjf2l1a"),e.relationships[t].data=n}}}),e.lastupdate=o._lastupdate_time,0===s.length?i(o):Promise.all(s).then(function(e){i(e)}).catch(function(e){n(e)})}).catch(function(){n()})})]})})},e.prototype.setResource=function(e){O.injectedServices.JsonapiStoreService.saveObject(e.type+"."+e.id,e.toObject().data)},e.prototype.getCollectionFromStorePromise=function(e,t,r){return $(this,void 0,void 0,function(){var i=this;return v(this,function(n){return[2,new Promise(function(n,o){i.getCollectionFromStore(e,t,r,n,o)})]})})},e.prototype.getCollectionFromStore=function(e,t,r,i,n){var o=this;O.injectedServices.JsonapiStoreService.getObjet("collection."+e).then(function(e){if(o.fillCollectionWithArrrayAndResourcesOnMemory(e.data,r))return r.$source="store",r.$cache_last_update=e._lastupdate_time,void i(r);o.fillCollectionWithArrrayAndResourcesOnStore(e,t,r).then(function(){if("new"!==r.$source)throw console.warn("ts-angular-json: esto no debería pasar. buscar eEa2ASd2#"),new Error("ts-angular-json: esto no debería pasar. buscar eEa2ASd2#");r.$source="store",r.$cache_last_update=e._lastupdate_time,i(r)}).catch(function(){n()})}).catch(function(){n()})},e.prototype.fillCollectionWithArrrayAndResourcesOnMemory=function(e,t){var r=!0;for(var i in e){var n=e[i],o=this.getResourceFromMemory(n);if(o.is_new){r=!1;break}t[n.id]=o}return r},e.prototype.getResourceFromMemory=function(e){return A.getService(e.type).cachememory.getOrCreateResource(e.type,e.id)},e.prototype.fillCollectionWithArrrayAndResourcesOnStore=function(e,t,r){return $(this,void 0,void 0,function(){var i=this;return v(this,function(n){return[2,new Promise(function(n,o){var s={},a=[];for(var c in e.data){var u=e.data[c],l=A.getService(u.type).cachememory;s[u.id]=l.getOrCreateResource(u.type,u.id),a.push(i.getResource(s[u.id],t))}Promise.all(a).then(function(t){for(var i in e.page&&(r.page=e.page),s){var o=s[i];r[o.id]=o}n(r)}).catch(function(e){o(e)})})]})})},e.prototype.setCollection=function(e,t,r){var i=this,n={data:{},page:{}},o={};m.forEach(t,function(e){i.setResource(e),n.data[e.id]={id:e.id,type:e.type},m.forEach(r,function(t){if("id"in e.relationships[t].data){var r=e.relationships[t].data;o[t+r.id]=r}else{var i=e.relationships[t].data;m.forEach(i,function(e){o[t+e.id]=e})}})}),n.page=t.page,O.injectedServices.JsonapiStoreService.saveObject("collection."+e,n),m.forEach(o,function(e){"is_new"in e?i.setResource(e):console.warn("No se pudo guardar en la cache el",e.type,"por no se ser Resource.",e)})},e.prototype.deprecateCollections=function(e){return O.injectedServices.JsonapiStoreService.deprecateObjectsWithKey("collection."+e),!0},e}(),q=function(e){function t(){var t=e.apply(this,arguments)||this;return t.resource=I,t.smartfiltertype="undefined",t}return d(t,e),t.prototype.register=function(){if(null===O.me)throw new Error("Error: you are trying register `"+this.type+"` before inject JsonapiCore somewhere, almost one time.");return this.cachememory=new D,this.cachestore=new T,this.schema=Object.assign({},m.Schema,this.schema),O.me.registerService(this)},t.prototype.newResource=function(){return new this.resource},t.prototype.new=function(){var e=this.newResource();return e.type=this.type,this.getService(),e.reset(),e},t.prototype.getPrePath=function(){return""},t.prototype.getPath=function(){return this.path?this.path:this.type},t.prototype.get=function(e,t,r,i){return this.__exec({id:e,params:t,fc_success:r,fc_error:i,exec_type:"get"})},t.prototype.delete=function(e,t,r,i){return this.__exec({id:e,params:t,fc_success:r,fc_error:i,exec_type:"delete"})},t.prototype.all=function(e,t,r){return this.__exec({id:null,params:e,fc_success:t,fc_error:r,exec_type:"all"})},t.prototype.__exec=function(t){var r=e.prototype.proccess_exec_params.call(this,t);switch(r.exec_type){case"get":return this._get(r.id,r.params,r.fc_success,r.fc_error);case"delete":return this._delete(r.id,r.params,r.fc_success,r.fc_error);case"all":return this._all(r.params,r.fc_success,r.fc_error)}},t.prototype._get=function(e,t,r,i){var o=this,s=new E;s.applyParams(this,t),s.appendPath(e);var a=this.getService().cachememory.getOrCreateResource(this.type,e);a.is_loading=!0;var c=new p.BehaviorSubject(a),u=t.ttl||0;if(this.getService().cachememory.isResourceLive(e,u)){var l=new Promise(function(e,t){e(r),l.then(function(e){console.warn("vp-ngx-jsonapi: THIS CODE NEVER RUN, RIGHT? :/ Please check."),c.next(a),o.runFc(e,"cachememory")}).catch(n.noop),a.is_loading=!1});return c.next(a),c.complete(),c.asObservable()}return O.injectedServices.rsJsonapiConfig.cachestore_support?this.getService().cachestore.getResource(a).then(function(e){m.isObjectLive(u,a.lastupdate)?(c.next(a),o.runFc(r,{data:e})):o.getGetFromServer(s,r,i,a,c)}).catch(function(e){o.getGetFromServer(s,r,i,a,c)}):this.getGetFromServer(s,r,i,a,c),c.next(a),c.asObservable()},t.prototype.getGetFromServer=function(e,t,r,i,n){var o=this;O.injectedServices.JsonapiHttp.get(e.get()).then(function(e){A.build(e,i),i.is_loading=!1,o.getService().cachememory.setResource(i),O.injectedServices.rsJsonapiConfig.cachestore_support&&o.getService().cachestore.setResource(i),n.next(i),n.complete(),o.runFc(t,e)}).catch(function(e){n.error(e),o.runFc(r,e)})},t.prototype._all=function(e,t,r){var i=this;e.smartfilter&&"localfilter"!==this.smartfiltertype&&Object.assign(e.remotefilter,e.smartfilter),e.cachehash=e.cachehash||"";var o=new E,s=new M;o.applyParams(this,e),e.remotefilter&&Object.keys(e.remotefilter).length>0&&(this.getService().parseToServer&&this.getService().parseToServer(e.remotefilter),o.addParam(s.toparams({filter:e.remotefilter}))),e.page&&(e.page.number>1&&o.addParam(O.injectedServices.rsJsonapiConfig.parameters.page.number+"="+e.page.number),e.page.size&&o.addParam(O.injectedServices.rsJsonapiConfig.parameters.page.size+"="+e.page.size));var a,c=this.getService().cachememory.getOrCreateCollection(o.getForCache()),u=new H(e.localfilter);a=e.localfilter&&Object.keys(e.localfilter).length>0?m.newCollection():c;var l=new p.BehaviorSubject(a),h=e.ttl||this.schema.ttl;if(h>=0&&this.getService().cachememory.isCollectionExist(o.getForCache()))if(c.$source="memory",e.smartfilter&&"localfilter"===this.smartfiltertype&&Object.assign(e.localfilter,e.smartfilter),u.filterCollection(c,a),this.getService().cachememory.isCollectionLive(o.getForCache(),h))var f=new Promise(function(e,r){e(t),f.then(function(e){l.next(c),i.runFc(e,"cachememory")}).catch(n.noop)});else this.getAllFromServer(o,e,t,r,c,a,l);else O.injectedServices.rsJsonapiConfig.cachestore_support?(c.$is_loading=!0,this.getService().cachestore.getCollectionFromStorePromise(o.getForCache(),o.includes,c).then(function(n){c.$source="store",c.$is_loading=!1,i.getService().cachememory.setCollection(o.getForCache(),c),u.filterCollection(c,a),m.isObjectLive(h,c.$cache_last_update)?(l.next(c),i.runFc(t,{data:n})):i.getAllFromServer(o,e,t,r,c,a,l)}).catch(function(n){i.getAllFromServer(o,e,t,r,c,a,l)})):(c.$is_loading=!0,this.getAllFromServer(o,e,t,r,c,a,l));return l.next(a),l.asObservable()},t.prototype.getAllFromServer=function(e,t,r,i,n,o,s){var a=this;n.$is_loading=!0,O.injectedServices.JsonapiHttp.get(e.get()).then(function(i){if(n.$source="server",n.$is_loading=!1,t.cachehash&&m.forEach(i.data,function(e){e.id=e.id+t.cachehash}),A.build(i,n),a.getService().cachememory.setCollection(e.getForCache(),n),O.injectedServices.rsJsonapiConfig.cachestore_support&&a.getService().cachestore.setCollection(e.getForCache(),n,t.include),new H(t.localfilter).filterCollection(n,o),"undefined"===a.smartfiltertype){var c=n.page;1===c.number&&c.total_resources<=c.resources_per_page?a.smartfiltertype="localfilter":1===c.number&&c.total_resources>c.resources_per_page&&(a.smartfiltertype="remotefilter")}s.next(n),s.complete(),a.runFc(r,i)}).catch(function(e){n.$is_loading=!1,s.next(n),s.error(e),a.runFc(i,e)})},t.prototype._delete=function(e,t,r,i){var n=this,o=new E;o.applyParams(this,t),o.appendPath(e);var s=new l.Subject;return O.injectedServices.JsonapiHttp.delete(o.get()).then(function(t){n.getService().cachememory.removeResource(e),s.next(),s.complete(),n.runFc(r,t)}).catch(function(e){s.error(e),n.runFc(i,e)}),s.asObservable()},t.prototype.getService=function(){return A.getService(this.type)||this.register()},t.prototype.clearCacheMemory=function(){var e=new E;return e.applyParams(this),this.getService().cachememory.deprecateCollections(e.getForCache())&&this.getService().cachestore.deprecateCollections(e.getForCache())},t.prototype.parseToServer=function(e){},t.prototype.parseFromServer=function(e){},t}(P);e.Autoregister=function(){return function(e){var t=e,r=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var i=t.apply(this,e);return i.register(),i};return r.prototype=t.prototype,r}},e.JsonapiCore=O,e.Resource=I,e.Service=q,e.VpNgxJsonapiModule=R,e.ɵa=g,e.ɵe=P,e.ɵd=S,e.ɵc=w,e.ɵb=x,Object.defineProperty(e,"__esModule",{value:!0})});